# setup-hbx 使用说明

## 1. 概述
`setup-hbx` 是一个 GitHub Action，集成了多份 HBuilderX 核心归档及依赖初始化脚本，可在 CI/CD 流程中一键完成 UniApp（Vite + Vue3）APP 构建。工作流只需引用 `uses: username/setup_hbx@vX` 并指定 `core_version`，即可自动解压 `core-xxx.zip/.tar.gz`、运行 `core-install.sh`，并调用官方 CLI 完成打包。

## 2. 目录结构
```
setup-hbx/
├─ action.yml                        # Composite Action 定义
├─ core-3.9.5.zip 等多份归档           # HBuilderX 核心压缩包
├─ core-install.sh                   # 安装脚本，支持 CORE_ROOT 自动探测
├─ scripts/
│  ├─ extract-core.sh                # 根据 core_version 解压归档
│  ├─ setup-core.sh                  # 对解压后的核心执行依赖安装
│  └─ run-app.js                     # Linux 下执行 app 构建
├─ .github/workflows/
│  └─ uni-build.yml                  # 演示 workflow（使用本地 Action）
└─ docs/说明书.md                    # 当前文档
```

## 3. GitHub Actions 使用方法
在待打包的 UniApp 仓库中添加如下 workflow（将 `username/setup_hbx` 换成实际仓库/tag）：

```yaml
name: Build UniApp

on:
  push:
    branches: [ main ]

jobs:
  app-plus:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 构建 App
        uses: username/setup_hbx@v1
        with:
          core_version: '4.86'     # 可选，支持的版本见下文
          uni_project_dir: .
          output_dir: uni-result

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: uni-result
          path: uni-result
```

Action 会自动完成：
1. 安装 Node.js 20 与 Yarn；
2. 解压 `core_version` 对应的归档，得到 `CORE_ROOT`；
3. 执行 `setup-core.sh`（内部调用 `core-install.sh`）安装依赖；
4. 切换到 `uniapp-cli-vite`，执行 `node node_modules/@dcloudio/vite-plugin-uni/bin/uni.js build -p app`；
5. 将产物写入 `output_dir`，并通过 `output-dir` 输出绝对路径。

### 3.1 输入参数
| 参数 | 说明 | 默认值 |
| ---- | ---- | ------ |
| `core_version` | HBuilderX 核心版本或归档文件名（例如 `4.86`、`core-3.9.5.zip`） | `4.86` |
| `uni_project_dir` | 待构建的 UniApp 项目路径（相对 `GITHUB_WORKSPACE` 或绝对路径） | `.` |
| `output_dir` | 构建产物输出路径 | `result` |
| `node_env` | `UNI_NODE_ENV` 的值 | `production` |

### 3.2 输出
| 输出 | 说明 |
| ---- | ---- |
| `output-dir` | 构建结果的绝对路径，可用于上传 artifact、发布包等 |

## 4. 本地调试
可在 Action 仓库内模拟 CI 流程：

```bash
# 解压所需核心，返回 CORE_ROOT
CORE_ROOT=$(RUNNER_TEMP=./.tmp GITHUB_ACTION_PATH=$PWD bash scripts/extract-core.sh 4.86)

npm install
CORE_ROOT="$CORE_ROOT" npm run setup
UNI_INPUT_DIR=/path/to/uni-project \
UNI_OUTPUT_DIR=$PWD/result \
HBX_PLUGIN_DIR="$CORE_ROOT/plugins/uniapp-cli-vite" \
npm run app
```

确保设置 `CORE_ROOT`、`UNI_INPUT_DIR`、`UNI_OUTPUT_DIR` 等变量，即可重现 Action 行为。

## 5. 支持的核心版本
仓库根目录中自带以下归档，可直接通过 `core_version` 指定：

- `3.9.5` → `core-3.9.5.zip`
- `3.9.8` → `core-3.9.8.zip`
- `3.9.9` → `core-3.9.9.tar.gz`
- `4.0.7` → `core-4.0.7.tar.gz`
- `4.15.0` → `core-4.15.0.tar.gz`
- `4.86` → `core-4.86.tar.gz`

如果需要其他版本，只需把新的 `core-<version>.tar.gz` 或 `.zip` 放到仓库根目录，并在 workflow 中将 `core_version` 设为相应版本号或完整文件名。

## 6. 常见问题
| 问题 | 解决方案 |
| ---- | -------- |
| `UNI_INPUT_DIR is not set` | 在 workflow 的 `with` 中设置 `uni_project_dir`，或在本地导出该环境变量。 |
| 找不到核心文件 | 确认仓库存在对应的 `core-*.zip/.tar.gz`，或直接在 `core_version` 里填写具体文件名。 |
| `cli binary not found` | 首次运行需要 `npm run setup`（Action 自动执行）以安装 `@dcloudio/vite-plugin-uni` 等依赖。 |
| 自定义核心 | 向仓库添加新的 `core-xxx` 归档，并在 workflow 中把 `core_version` 设置为该版本。 |

## 7. 版本发布
1. 在本仓库完成改动并 push；
2. 创建 tag（如 `v1.0.0`）；
3. 在业务项目 workflow 中通过 `uses: username/setup_hbx@v1.0.0` 引用该版本。
